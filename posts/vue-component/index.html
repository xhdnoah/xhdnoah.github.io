<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css href=/css/bootstrap.min.css>
<link rel=stylesheet type=text/css href=/css/style.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/themes/prism.css>
<link rel=icon type=image/png href=/images/favicon.ico>
<link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%221em%22 font-size=%2280%22>ğŸŒ•</text></svg>">
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/components/prism-core.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=https://use.fontawesome.com/93f8d6d0b2.js></script>
<title>ç”µå­æœˆäº® | Vue åˆå§‹åŒ–ï¼šä» createElement åˆ° Component Tree</title>
</head>
<body>
<header class="header fadeInTop content">
<a class=no-highlight href=/>ElectronicMoon</a>
</header>
<main class=main>
<div class="content-container fadeInTop">
<div class=content>
<h1 class=title>Vue åˆå§‹åŒ–ï¼šä» createElement åˆ° Component Tree</h1>
<div class=post-meta>
<time datetime="2019-12-19 00:00:00 +0000 UTC">Dec 19, 2019</time>
</div>
<p>æœ¬æ–‡ä»‹ç» Vue ç»„ä»¶çš„åˆå§‹åŒ–è¿‡ç¨‹</p>
<p><strong>createComponent</strong></p>
<p>åœ¨ <code>_createElement</code> æ–¹æ³•ä¸­ï¼Œç¨‹åºå¯¹å‚æ•° <code>tag</code> è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªåŸç”Ÿçš„æ ‡ç­¾ï¼Œå°±ä¼šæŒ‰ä¸Šæ–‡çš„åˆ†æç”Ÿæˆä¸€ä¸ªæ™®é€šçš„ VNode èŠ‚ç‚¹ï¼›å¦‚æœæ˜¯ä¸€ä¸ªå·²æ³¨å†Œçš„ç»„ä»¶åï¼Œå°±ä¼šèµ°åˆ° <code>createComponent</code> åˆ›å»ºä¸€ä¸ªç»„ä»¶ VNode</p>
<pre><code class=language-javascript>export function createComponent(
	Ctor: Class&lt;Component&gt; | Function | Object | void,
	data: ?VNodeData,
	context: Component,
	children: ?Array&lt;VNode&gt;,
	tag?: string
): VNode | Array&lt;VNode&gt; | void{
  // baseCtor æŒ‡å‘ Vue
  const baseCtor = context.$options._base
  if(isObject(Ctor)){
    Ctor = baseCtor.extend(Ctor)
  }

	// async component
	let asyncFactory
  if(isUndef(Ctor.cid)){
    asyncFactor = Ctor
    Ctor = resolveAsyncComponent(asyncFactory, baseCtor, context)
    if(Ctor === undefined){
      return createAsyncPlaceholder(...)
    }
  }

  data = data || {}

  resolveConstructorOptions(Ctor)

  if(isDef(data.model)){
    transformModel(Ctor.options, data)
  }

  installComponentHooks(data)
  // return a placeholder vnode
  const name = Ctor.options.name || tag
  const vnode = new VNode(
    `vue-component-${Ctor.cid}${name ? `-${name}` : ''}`,
    data, undefined, undefined, undefined, context,
    { Ctor, propsData, listeners, tag, children },
    asyncFactory
  )

  return vnode
}
</code></pre>
<p><strong>Vue.extend</strong></p>
<p>ä¸€ä¸ª Vue ç»„ä»¶å°±æ˜¯å¯¹ Vue å¯¹è±¡çš„ç»§æ‰¿å’Œæ‰©å±•ï¼ŒVue ä½¿ç”¨ <code>Vue.extend</code> æ„é€ ä¸€ä¸ª <code>Vue</code> å­ç±»ï¼Œä½¿ç”¨åŸå‹ç»§æ‰¿æ–¹å¼ç”Ÿæˆä¸€ä¸ªå­ç±»çš„æ„é€ å™¨ Sub å¹¶è¿”å›ï¼Œå¯¹ Sub å¯¹è±¡æœ¬èº«æ‰©å±•å±æ€§ï¼Œå¹¶åˆå§‹åŒ– props computed ç­‰é€‰é¡¹ï¼Œæœ€åå°†æ„é€ å™¨ç¼“å­˜ä»¥ä¾¿äºå¤ç”¨</p>
<pre><code class=language-javascript>Vue.extend = function(extendOptions: Object): Function {
	extendOptions = extendOptios || {}
	const Super = this
	const SuperId = Super.cid
	const cachedCtors = extendOptions._Ctor || (extendOptions._Ctor = {})
	if(cachedCtors[SuperId]){
		return cachedCtors[SuperId]
	}

	const Sub = function VueComponent(options){
		this._init(options)
	}
	Sub.prototype = Object.create(Super.prototype)
	Sub.prototype.constructor = Sub
	Sub.cid = cid++
	Sub.options = mergeOptions(
		Super.options,
		extendOptions
	)
	Sub['super'] = Super
	if(Sub.options.props){
		initProps(Sub)
	}
	if(Sub.options.computed){
		initComputed(Sub)
	}
	Sub.extend = Super.extend
	Sub.mixin = Super.mixin
	Sub.use = Sub.use

	cachedCtors[SuperId] = Sub
	return Sub
}
</code></pre>
<p>å½“å®ä¾‹åŒ– Sub æ—¶ï¼Œå°±ä¼šæ‰§è¡Œ <code>this._init </code> å†æ¬¡èµ°åˆ° Vue å®ä¾‹åŒ–çš„åˆå§‹åŒ–é€»è¾‘</p>
<p><strong>å®ä¾‹åŒ–ç»„ä»¶ VNode</strong></p>
<pre><code class=language-javascript>const name = Ctor.options.name || tag
const vnode = new VNode(
  `vue-component-${Ctor.cid}${name ? `-${name}` : ''}`,
  data, undefined, undefined, undefined, context,
  { Ctor, propsData, listeners, tag, children },
  asyncFactory
)
return vnode
</code></pre>
<p>è¿”å›çš„ç»„ä»¶ VNode æ˜¯ä¸€ä¸ªæ²¡æœ‰ children çš„å ä½ç¬¦ <code>vnode</code></p>
<p><strong>createComponent</strong></p>
<p>å’Œ <code>createElement</code> ä¸­çš„åŒåæ–¹æ³•ä¸ä¸€æ ·ï¼Œè¿™é‡Œçš„ <code>createComponent</code> æ˜¯æ‰§è¡Œåˆ° <code>createElm</code> ä¸­ç”¨æ¥è½¬æ¢çœŸå® DOM èŠ‚ç‚¹çš„æ–¹æ³•</p>
<pre><code class=language-javascript>function createElm(
	vnode,
	insertedVnodeQueue,
	parentElm,
	refElm,
	nested,
	ownerArray,
	index
) {
	//...
	if(createComponent(vnode, insertedVnodeQueue, parentElm, refElm)){
		return
	}
  //...
}
</code></pre>
<p><code>createComponent</code> æ–¹æ³•é€šè¿‡ <code>vnode.data</code> æ ¡éªŒä¼ å…¥çš„æ˜¯å¦ä¸ºç»„ä»¶ VNodeï¼Œè¯»å– data ä¸­çš„ init é’©å­å‡½æ•°å¹¶æ‰§è¡Œ</p>
<pre><code class=language-javascript>function createComponent(vnode, insertedVnodeQueue, parentElm, refElm){
	let i = vnode.data
	if(isDef(i)){
		const isReactivated = isDef(vnode.componentInstance) &amp;&amp; i.keepAlive
    // i.hook ä¸” hook.init å­˜åœ¨åˆ™åˆ¤æ–­ä¸ºç»„ä»¶ VNode
		if(isDef(i = i.hook) &amp;&amp; isDef(i = i.init)){
      // æ‰§è¡Œ init
			i(vnode, false)
		}
	}
}
</code></pre>
<p><strong>init hook</strong></p>
<pre><code class=language-javascript>const componentVNodeHooks = {
	init(vnode: VNodeWithData, hydrating: boolean): ?boolean{
		if(
			vnode.componentInstance &amp;&amp;
			!vnode.componentInstance._isDestroyed &amp;&amp;
			vnode.data.keepAlive
		){
			// ...keepAlive
		} else {
			const child = vnode.componentInstance = createComponentInstanceForVnode(
        // çˆ¶çš„å ä½ç¬¦ VNode
				vnode,
        // vm å®ä¾‹
				activeInstance
			)
			child.$mount(hydrating ? vnode.elm : undefined, hydrating)
		}
	}
}
</code></pre>
<p><strong>createComponentInstanceForVnode</strong></p>
<p>Init é’©å­é€šè¿‡ <code>createComponentInstanceForVnode</code> åˆ›å»ºä¸€ä¸ª Vue å®ä¾‹ï¼Œè°ƒç”¨ <code>$mount</code> æŒ‚è½½å­ç»„ä»¶ï¼Œé€‰é¡¹ä¸­çš„ <code>_parentVnode</code> è¡¨ç¤ºç»„ä»¶çš„å ä½èŠ‚ç‚¹ï¼Œ<code>parent</code> è¡¨ç¤ºå½“å‰æ¿€æ´»ç»„ä»¶çš„å®ä¾‹ï¼ŒVue.js é€šè¿‡ä¸€ä¸ªå…¨å±€å˜é‡ <code>activeInstance</code> åœ¨ä¸Šä¸‹æ–‡ä¸­ä¿å­˜å½“å‰æ¿€æ´»çš„å®ä¾‹</p>
<pre><code class=language-javascript>function createComponentInstanceForVnode (
   vnode: any,
   parent: any
): Component {
   const options: InternalComponentOptions = {
       _isComponent: true,
       _parentVnode: vnode,	// å ä½èŠ‚ç‚¹
       parent // å½“å‰æ¿€æ´»ç»„ä»¶çš„å®ä¾‹ï¼ˆå­ç»„ä»¶çš„çˆ¶ vm å®ä¾‹ï¼‰
   }
 // check inline-template render functions
   ...
   return new vnode.componentOptions.Ctor(options)
}
</code></pre>
<p>è¿™é‡Œçš„ <code>vnode.componentOptions.Ctor</code> å¯¹åº”çš„å°±æ˜¯å­ç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œå­ç»„ä»¶çš„å®ä¾‹åŒ–å¼€å§‹ï¼Œæ‰§è¡Œåˆ° <code>_init</code> ï¼Œç»„ä»¶ VNode å’Œæ™®é€š VNode åˆå§‹åŒ–çš„ä¸åŒä¹‹å¤„åœ¨åˆå¹¶ options å’ŒæŒ‚è½½è¿‡ç¨‹</p>
<pre><code class=language-javascript>Vue.prototype._init = function(options?: Object){
	const vm: Component = this
	if(options &amp;&amp; options._isComponent){
		initInternalComponent(vm, options)
	} else {
		vm.$options = mergeOptions(
			resolveConstructorOptions(vm.constructor),
			options || {},
			vm
		)
	}
	//...
	if(vm.$options.el){
		vm.$mount(vm.$options.el)
	}
}
</code></pre>
<p><strong>initInternalComponent</strong></p>
<pre><code class=language-javascript>export function initInternalComponent (vm: Component, options: InternalComponentOptions){
	const opts = vm.$options = Object.create(vm.constructor.options)
  const parentVnode = options._parentVnode
  opts.parent = options.parent
  opts._parentVnode = parentVnode

  const vnodeComponentOptions = parentVnode.componentOptions
  opts.propsData = vnodeComponentOptions.propsData
  opts._parentListeners = vnodeComponentOptions.listeners
  opts._renderChildren = vnodeComponentOptions.children
  opts._componentTag = vnodeComponentOptions.tag

  if (options.render) {
    opts.render = options.render
    opts.staticRenderFns = options.staticRenderFns
  }
}
</code></pre>
<p>å…¶ä¸­ <code>opts.parent = options.parent opts._parentVnode = parentVnode</code> æ˜¯æŠŠä¹‹å‰é€šè¿‡ <code>createComponentInstanceForVnode</code> ä¼ å…¥çš„å‚æ•°åˆå¹¶åˆ°å†…éƒ¨çš„é€‰é¡¹ $options ä¸­</p>
<p><strong>child.$mount</strong></p>
<p>åœ¨ <code>_init</code> å‡½æ•°æœ€åæœ‰</p>
<pre><code class=language-js>if (vm.$options.el) {
   vm.$mount(vm.$options.el)
}
</code></pre>
<p>ç»„ä»¶åˆå§‹åŒ–ä¸ä¼  elï¼Œè‡ªå·±æ‰§è¡Œäº† $mountï¼Œ <code>compoenentVNodeHooks</code> çš„ <code>init</code> é’©å­å‡½æ•°åœ¨å®ä¾‹åŒ– <code>_init</code> åï¼Œæ¥ç€æ‰§è¡Œ <code>child.$mount(hydrating ? vnode.elm : undefined, hydrating)</code>ï¼Œæœ€ç»ˆè°ƒç”¨ <code>mountComponent</code>ï¼Œè¿›è€Œæ‰§è¡Œ <code>vm._render()</code></p>
<p><strong>vm._render()</strong></p>
<pre><code class=language-javascript>Vue.prototype._render = function(): VNode{
	const vm: Component = this
	const { render, _parentVnode } = vm.$options

	vm.$vnode = _parentVnode
	let vnode
	try{
		vnode = render.call(vm._renderProxy, vm.$createElement)
	} catch(e){
		...
	}

	vnode.parent = _parentVnode
	return vnode
}
</code></pre>
<p>è¿™é‡Œçš„ <code>_parentVnode</code> å°±æ˜¯å½“å‰ç»„ä»¶çˆ¶çš„å ä½ç¬¦ VNodeï¼Œ <code>render.call()</code> ç”Ÿæˆçš„ <code>vnode</code> æ˜¯å½“å‰ç»„ä»¶çš„æ¸²æŸ“ VNodeï¼Œ<code>vnode</code> çš„ <code>parent</code> æŒ‡å‘äº† <code>_parentVnode</code>ï¼Œä¹Ÿå°±æ˜¯ <code>vm.$vnode</code></p>
<p>æ‰§è¡Œå®Œ <code>vm._render</code> ç”Ÿæˆæ¸²æŸ“ VNode åï¼Œæ¥ç€æ‰§è¡Œ <code>vm._update</code></p>
<p><strong>vm._update()</strong></p>
<pre><code class=language-javascript>export let activeInstance: any = null
// vnode æ¸²æŸ“ VNode
Vue.prototype._update = function (vnode: VNode, hydrating?: boolean){
	const vm: Component = this
	const prevEl = vm.$el
	const prevVnode = vm._vnode
	const prevActiveInstance = activeInstance
	activeInstance = vm
	vm._vnode = vnode
	if(!prevVnode){
		// initial render
		vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false)
	} else {
    // updates
    vm.$el = vm.__patch__(prevVnode, vnode)
  }
  activeInstance = prevActiveInstance
  // update __vue__ reference
  if(prevEl){
    prevEl.__vue__ = null
  }
  if(vm.$el){
    vm.$el.__vue__ = vm
  }
  // if parent is an HOC, update its $el as well
  if (vm.$vnode &amp;&amp; vm.$parent &amp;&amp; vm.$vnode === vm.$parent._vnode) {
    vm.$parent.$el = vm.$el
  }
  // updated hook is called by the scheduler to ensure that children are
  // updated in a parent's updated hook.
}
</code></pre>
<p>Vue 2.6 å¯¹ <code>lifecycleMixin()</code> è¿›ä¸€æ­¥æŠ½è±¡ï¼ŒæŠŠ reset æ“ä½œä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ä¿å­˜åœ¨ lifecycleMixin ä½œç”¨åŸŸä¸­</p>
<pre><code class=language-javascript>function setActiveInstance(vm: Component){
	const prevActiveInstance = activeInstance
	activeInstance = vm
	return () =&gt; {
		activeInstance = prevActiveInstance
	}
}

function lifecycleMixin(Vue: Class){
  Vue.prototype._update = function(vnode, hydrating){
    //...
    const restoreActiveInstance = setActiveInstance(vm)
    vm._vnode = vnode
    if (!prevVnode) {
      // initial render
      vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */)
    } else {
      // updates
      vm.$el = vm.__patch__(prevVnode, vnode)
    }
    restoreActiveInstance()
  }
}
</code></pre>
<p><code>vm._vnode = vnode</code> å…¶ä¸­ <code>vnode</code> æ˜¯é€šè¿‡<code>vm._render()</code> è¿”å›çš„ç»„ä»¶æ¸²æŸ“VNodeï¼Œ<code>vm._vnode</code> å’Œ <code>vm.$vnode</code> çš„å…³ç³»å°±æ˜¯ä¸€ç§çˆ¶å­å…³ç³»ï¼Œ<code>vm._vnode.parent = vm.$vnode</code></p>
<p><code>activeInstance</code> ä½œç”¨æ˜¯ä¿æŒå½“å‰ä¸Šä¸‹æ–‡æ­£åœ¨æ¿€æ´»çš„ Vue å®ä¾‹ï¼Œæ˜¯åœ¨ <code>lifecycle</code> æ¨¡å—çš„å…¨å±€å˜é‡ï¼Œåœ¨ä¹‹å‰æˆ‘ä»¬è°ƒç”¨ <code>createComponentInstanceForVnode</code> æ–¹æ³•çš„æ—¶å€™ä» <code>lifecycle</code> æ¨¡å—è·å–ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚Vue æ•´ä¸ªåˆå§‹åŒ–æ˜¯ä¸€ä¸ªæ·±åº¦éå†çš„è¿‡ç¨‹ï¼Œåœ¨å®ä¾‹åŒ–å­ç»„ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒéœ€è¦çŸ¥é“ä¸Šä¸‹æ–‡çš„ Vue å®ä¾‹æ˜¯ä»€ä¹ˆï¼Œå¹¶æŠŠå®ƒä½œä¸ºå­ç»„ä»¶çš„çˆ¶ Vue å®ä¾‹ã€‚åœ¨å¯¹å­ç»„ä»¶çš„å®ä¾‹åŒ–è¿‡ç¨‹ä¼šè°ƒç”¨ <code>initInternalComponentvm, options)</code> åˆå¹¶ <code>options</code>ï¼ŒæŠŠ <code>parent</code> å­˜åˆ° <code>vm.$options</code> ä¸­ï¼Œåœ¨ $mount å‰ä¼šè°ƒç”¨ <code>initLifecycle(vm)</code> å»ºç«‹çˆ¶å­å…³ç³»</p>
<p><strong>initLifecycle</strong></p>
<pre><code class=language-javascript>export function initLifecycle(vm: Component){
	const options = vm.$options
	let parent = options.parent
	if(parent &amp;&amp; !options.abstract){
		while(parent.$options.abstract &amp;&amp; parent.$parent){
      parent = parent.$parent
    }
    parent.$children.push(vm)
	}
  vm.$parent = parent
  //...
}
</code></pre>
<p>åœ¨ <code>vm._update</code> çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠå½“å‰çš„ <code>vm</code> èµ‹å€¼ç»™ <code>activeInstance</code>ï¼ŒåŒæ—¶é€šè¿‡ <code>prevActiveInstance</code> ä¿å­˜ä¸Šä¸€æ¬¡çš„ <code>activeInstance</code>ã€‚å®é™…ä¸Š<code>prevActiveInstance</code> å’Œå½“å‰çš„ <code>vm</code> æ˜¯ä¸€ä¸ªçˆ¶å­å…³ç³»ï¼Œå½“ä¸€ä¸ª <code>vm</code> å®ä¾‹å®Œæˆå®ƒçš„æ‰€æœ‰å­æ ‘çš„ patch/update è¿‡ç¨‹åï¼Œ<code>activeInstance</code> ä¼šå›åˆ°å®ƒçš„çˆ¶å®ä¾‹ï¼Œè¿™æ ·å°±å®Œç¾åœ°ä¿è¯äº† <code>createComponentInstanceForVnode</code> æ•´ä¸ªæ·±åº¦éå†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨å®ä¾‹åŒ–å­ç»„ä»¶çš„æ—¶å€™èƒ½ä¼ å…¥å½“å‰å­ç»„ä»¶çš„çˆ¶ Vue å®ä¾‹ï¼Œå¹¶åœ¨ <code>_init</code> çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ <code>vm.$parent</code> æŠŠè¿™ä¸ªçˆ¶å­å…³ç³»ä¿å­˜</p>
<blockquote>
<p>Patch æµç¨‹ï¼šcreateComponent -> å­ç»„ä»¶åˆå§‹åŒ– -> å­ç»„ä»¶ render ç”Ÿæˆæ¸²æŸ“ VNode -> å­ç»„ä»¶ patchï¼ˆéå†å­ç»„ä»¶æ¸²æŸ“ VNodeï¼Œé€’å½’ï¼Œç›´åˆ°æ™®é€šèŠ‚ç‚¹ï¼Œæ‰§è¡Œ insertï¼‰</p>
<p>activeInstance å½“å‰æ¿€æ´»å®ä¾‹ï¼Œvm.$vnode ä¸ºç»„ä»¶å ä½ vnodeï¼Œvm._vnode ä¸ºç»„ä»¶æ¸²æŸ“ vnode</p>
</blockquote>
<p>æœ€ç»ˆï¼Œå°†ç»„ä»¶åˆå§‹åŒ–è¿‡ç¨‹å’Œä¸Šç¯‡æ™®é€šèŠ‚ç‚¹åˆå§‹åŒ–è¿‡ç¨‹åˆå¹¶å¾—åˆ°ä»¥ä¸‹æµç¨‹ï¼Œä¸€ä¸ªå®Œæ•´ Vue é¡¹ç›®ä»¥æ­¤å¾ªç¯å®Œæˆæ¸²æŸ“</p>
<pre><code>     +----------+
     | new Vue()|
     +----+-----+
          |
     +----v-----+      +--------+    +---------+    +-----------------+
+----&gt;  _init   +------&gt; $mount +----&gt; compile +----&gt; render function +--+
|    +----------+      +--------+    +---------+    +-----------------+  |
|                                                                        |
|                                                                        |
|    +-----+     +-----------+     +-------+ update +-------+    +-------v-------+
|    | DOM &lt;-----+ createElm &lt;-----+ patch &lt;--------+ vnode &lt;----+ createElement +--+
|    +-----+     +-----------+     +-------+        +-------+    +---------------+  |
|                                                                                   |
|                                                                                   |
|    +-------------------------------+  init +-----------+    +--------+   +--------v--------+
+----+createComponentInstanceForVnode&lt;-------+ createElm &lt;----+ CVnode &lt;---+ createComponent |
     +-------------------------------+       +-----------+    +--------+   +-----------------+

</code></pre>
</div>
</main>
</body>
</html>