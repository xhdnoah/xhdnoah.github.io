<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css href=/css/bootstrap.min.css>
<link rel=stylesheet type=text/css href=/css/style.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/themes/prism.css>
<link rel=icon type=image/png href=/images/favicon.ico>
<link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%221em%22 font-size=%2280%22>ğŸŒ•</text></svg>">
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/components/prism-core.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=https://use.fontawesome.com/93f8d6d0b2.js></script>
<title>ç”µå­æœˆäº® | UnderScore: å‡½æ•°</title>
</head>
<body>
<header class="header fadeInTop content">
<a class=no-highlight href=/>ElectronicMoon</a>
</header>
<main class=main>
<div class="content-container fadeInTop">
<div class=content>
<h1 class=title>UnderScore: å‡½æ•°</h1>
<div class=post-meta>
<time datetime="2019-03-20 00:00:00 +0000 UTC">Mar 20, 2019</time>
</div>
<h3 id=ä¸Šä¸‹æ–‡ç»‘å®š>ä¸Šä¸‹æ–‡ç»‘å®š</h3>
<p>underscore æä¾›ç»‘å®šå‡½æ•°ä¸Šä¸‹æ–‡çš„æ–¹æ³• <code>_.bind</code> å’Œ <code>_.bindAll</code>ï¼ŒäºŒè€…çš„ç»‘å®šä¸Šä¸‹æ–‡åŠæ‰§è¡Œè¿‡ç¨‹éƒ½ç”±å†…éƒ¨å‡½æ•° <code>executeBound</code> è´Ÿè´£</p>
<pre><code>// æ‰§è¡Œç»‘å®šåçš„å‡½æ•°
var executeBound = function(sourceFunc, boundFunc, context, callingContext, args){
  if(!(callingContext instanceof boundFunc))
  	return sourceFunc.apply(context, args)
  var self = baseCreate(sourceFunc, prototype)
  var result = sourceFunc.apply(self, args)
  if(_.isObject(result))
  	return result
  return self
}
</code></pre>
<p><code>executeBound</code> ä¹Ÿè€ƒè™‘äº†å½“ç»‘å®šåçš„å‡½æ•° <code>boundFunc</code> ä½œä¸ºæ„é€ å‡½æ•°è¢« <code>new</code> è¿ç®—çš„æƒ…å½¢ï¼Œè¿›è¡Œäº†æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¿®æ­£ã€‚å¦å¤–ä¸ºäº†æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œæ‰€ä»¥æœ‰ä»¥ä¸‹è¯­å¥ï¼š</p>
<pre><code>var result = sourceFunc.apply(self, args)
if(_.isObject(result))
	return result
return self
</code></pre>
<p><strong><code>_.bind(func, context)</code></strong> å°† func çš„æ‰§è¡Œä¸Šä¸‹æ–‡ç»‘å®šåˆ° context</p>
<pre><code>_.bind = function(func, context){
  if(nativeBind &amp;&amp; func.bind === nativeBind) return nativeBind.apply(func, slice.call(arguments, 1))
  if(!_.isFunction(func)) throw new TypeError('Bind must be called on a function')
  var args = slice.call(arguments, 2)
  var bound = function(){
    return executeBound(func, bound, context, this, args.concat(slice.call(arguments)))
  }
  return bound
}
</code></pre>
<h3 id=åå‡½æ•°>åå‡½æ•°</h3>
<p>åå‡½æ•° partial åæ˜ äº†æ–°å‡½æ•°æ˜¯åŸå‡½æ•°çš„ä¸€éƒ¨åˆ†ï¼Œunderscore çš„ <code>_.partial</code> è¿”å›ä¸€ä¸ªåå‡½æ•°</p>
<p><strong><code>_.partial(func, ...args)</code></strong>ï¼šååº”ç”¨ä¸€ä¸ªå‡½æ•° <code>func</code></p>
<pre><code>_.partial = restArgs(function(func, boundArgs){
  var placeholder = _.partial.placeholder
  var bound = function(){
    // position æ ‡è¯†å½“å‰èµ‹å€¼çš„ arguments æœ€æ–°ä½ç½®
    var position = 0, length = boundArgs.length
    var args = Array(length)
    for(var i = 0;i &lt; length; i++){
      args[i] = boundArgs[i] === placeholder ? arguments[position++] : boundArgs[i]
    }
    while(position &lt; arguments.length) args.push(arguments[position++])
    return executeBound(func, bound, this, this, args)
  }
  return bound
})
</code></pre>
<p>underscore æä¾›çš„åå‡½æ•°æ”¯æŒä¼ é€’å ä½ç¬¦ï¼Œå ä½ç¬¦ç”¨æ¥æ ‡è¯†ä¸æƒ³è¢«åˆå§‹åŒ–çš„å‚æ•°</p>
<pre><code>var substract = function(a, b){
  return b - a
}
sub5 = _.partial(subtract, 5)
sub5(20) // =&gt; 15

// é€šè¿‡ä½¿ç”¨ä¸€ä¸ª placeholder _,å…ˆèµ‹å€¼ bï¼Œæš‚ç¼“å¯¹ a èµ‹å€¼
subFrom20 = _.partial(subtract, _, 20)
subFrom20(5)
// =&gt; 15
</code></pre>
<h3 id=ç¼“å­˜>ç¼“å­˜</h3>
<pre><code>function fibonacci(n){
  return n&lt;2 ? n : fibonacci(n-1) + fibonacci(n-2)
}
</code></pre>
<pre><code>fibonacci(5) é€’å½’è¿‡ç¨‹
fibonacci(5) = fibonacci(4) + fibonacci(3)
fibonacci(4) = fibonacci(3) + fibonacci(2)
fibonacci(3) = fibonacci(2) + fibonacci(1)
// ...
</code></pre>
<p>æ±‚è§£æ–æ³¢é‚£å¥‘æ•°åˆ—æ—¶ï¼Œé€’å½’è¿‡ç¨‹å¼•èµ·äº†å¾ˆå¤šé‡å¤è®¡ç®—ï¼Œè€ƒè™‘å°†è®¡ç®—ç»“æœè¿›è¡Œç¼“å­˜ï¼Œéœ€è¦åˆ©ç”¨åˆ°é«˜é˜¶å‡½æ•°å’Œé—­åŒ…ï¼š</p>
<pre><code>var fibonacciWithMemo = (function(){
  var memo = {}
  return function fibnocci(n){
  	// å¦‚æœå°šæœªå»ºç«‹ç¼“å­˜
    if(!memo[n]){
      memo[n] = n &lt; 2 ? n : fibonacci(n-1) + fibonacci(n-2)
    }
    return memo[n]
  }
}())
</code></pre>
<pre><code>fibonacciWithMemo(5)
memo(5) = memo[4] + memo[3]
memo[4] = memo[3] + memo[2]
memo[3] = memo[2] + memo[1]
// ...
</code></pre>
<p>underscore å°è£…äº†ä¸€ä¸ªé€šç”¨çš„ç¼“å­˜å‡½æ•°åˆ›å»ºå™¨ <code>_.memoize</code></p>
<p><strong><code>_.memoize(func, hasher)</code></strong> ä¸ºå‡½æ•° func æä¾›è®°å¿†åŠŸèƒ½ï¼Œ hasher å®šä¹‰å¦‚ä½•è·å¾—ç¼“å­˜</p>
<pre><code>_.memoize = function(func, hasher){
  var memoize = function(key){
  	// æ‰§è¡Œè®°å¿†å‡½æ•°æ—¶ï¼Œå…ˆè·å¾—ç¼“å­˜
  	var cache = memoize.cache
  	// è·å¾—ç¼“å­˜åœ°å€
  	var address = '' + (hasher ? hasher.apply(this, arguments) : key)
  	// å¦‚æœç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œåˆ™éœ€è¦è°ƒç”¨å‡½æ•°æ‰§è¡Œ
  	if(!_.has(cache, address)) cache[address] = func.apply(this, arguments)
  	return cache[address]
  }
  // åˆå§‹åŒ–è®°å¿†å‡½æ•°çš„ç¼“å­˜
  memoize.cache = {}
  return memoize
}
</code></pre>
<p><code>_.memoize</code> å°†ç¼“å­˜ç»‘å®šåˆ°äº†ç¼“å­˜å‡½æ•°çš„ <code>cache</code> å±æ€§ä¸Šï¼Œåœ¨åˆ›å»ºä¸€ä¸ªç¼“å­˜å‡½æ•°æ—¶ï¼Œé™¤äº†æä¾›åŸå‡½æ•° <code>func</code> ç”¨æ¥è®¡ç®—å€¼å¤–ï¼Œè¿˜å¯ä»¥æä¾› <code>hasher</code> å‡½æ•°æ¥è‡ªå®šä¹‰å¦‚ä½•è·å¾—ç¼“å­˜çš„ä½ç½®ï¼Œä¸è®¾ç½® <code>hasher</code>ï¼Œåˆ™ä»¥ç¼“å­˜å‡½æ•°çš„å‚æ•° <code>key</code> æ ‡è¯†ç¼“å­˜ä½ç½®</p>
<pre><code>var fibonacci = _.memoize(function(n){
  return n &lt; 2 ? n : fibonacci(n-1) + fibonacci(n-2)
})
fibonacci(5) // =&gt; 5
console.log(fibonacci.cache)

// ä¼ é€’ hasher
var hasher = function(){
  var n = arguments[0]
  return n
}
var fibonacci = _.memoize(function(n){
  return n &lt; 2 ? n : fibonacci(n-1) + fibonacci(n-2)
}, hasher)

fibonacci(5)
console.log(fibonacci.cache)
</code></pre>
<h3 id=throttle--debounce>throttle & debounce</h3>
<blockquote>
<p>å‰ç«¯å¼€å‘åœºæ™¯ï¼šåœ¨é¡µé¢ä¸­ï¼Œå•å‡»"æŸ¥è¯¢"æŒ‰é’®ï¼Œä¼šé€šè¿‡ ajax å¼‚æ­¥è·å–æ•°æ®ã€‚å¦‚æœè¿™ä¸ªæŸ¥è¯¢æ˜¯è€—æ—¶çš„ï¼Œæˆ‘ä»¬éœ€è¦æ§åˆ¶æŸ¥è¯¢é€Ÿç‡é˜²æ­¢çŸ­æ—¶é—´å†…é¢‘ç¹è¯·æ±‚ã€‚</p>
</blockquote>
<blockquote>
<p>ç”µæ¢¯è¶…æ—¶ï¼šæŠŠç”µæ¢¯å®Œæˆä¸€æ¬¡è¿é€ï¼Œç±»æ¯”ä¸€æ¬¡å‡½æ•°çš„æ‰§è¡Œå’Œå“åº”ï¼Œå‡è®¾ç”µæ¢¯æœ‰ä¸¤ç§è¿è¡Œç­–ç•¥ <code>throttle</code> å’Œ <code>debounce</code>ï¼Œè¶…æ—¶è®¾å®š 15s</p>
<ul>
<li>throttle ç­–ç•¥ç”µæ¢¯ï¼Œä¿è¯å¦‚æœç”µæ¢¯ç¬¬ä¸€ä¸ªäººè¿›æ¥ï¼Œ15s åå‡†æ—¶è¿é€ä¸€æ¬¡ï¼Œä¸ç­‰å¾…ã€‚</li>
<li>debounce ç­–ç•¥ç”µæ¢¯ï¼Œå¦‚æœæœ‰äººè¿›ç”µæ¢¯ï¼Œç­‰å¾… 15sï¼Œå¦‚æœåˆæœ‰äººè¿›æ¥ï¼Œ15s ç­‰å¾…é‡æ–°è®¡æ—¶ï¼Œç›´åˆ° 15s è¶…æ—¶ï¼Œå¼€å§‹è¿é€ã€‚</li>
</ul>
</blockquote>
<h4 id=èŠ‚åˆ¶å‹æäº¤>èŠ‚åˆ¶å‹æäº¤</h4>
<p>æ–°å»ºä¸€ä¸ª wrapper åŒ…è£¹ <code>sendQuery</code> ä¸šåŠ¡ï¼Œåœ¨ <code>click</code> äº‹ä»¶åï¼Œä¸ä¼šç›´æ¥è°ƒç”¨ <code>sendQuery</code>ï¼Œè€Œæ˜¯è°ƒç”¨ wrapperã€‚wrapper ä¸­è·å–å½“å‰æ—¶é—´ï¼Œæ¯”è¾ƒè·ç¦»ä¸Šæ¬¡ <code>sendQuery</code> æ‰§è¡Œäº‹ä»¶çš„é—´éš”æ˜¯å¦æœ‰ 1sï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆè¿™æ¬¡è¯·æ±‚ç«‹å³æ‰§è¡Œï¼Œå¦åˆ™è®¡ç®—å‰©ä½™ç­‰å¾…æ—¶é—´å»¶è¿Ÿæ‰§è¡Œè¯¥è¯·æ±‚ï¼Œå€Ÿæ­¤æ§åˆ¶ä½ <code>sendQuery</code> çš„è°ƒç”¨é¢‘ç‡</p>
<p>ä¸ºé˜²æ­¢å˜é‡çš„å…¨å±€æ±¡æŸ“ï¼Œç”¨ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°åŒ…è£¹ä½œç”¨åŸŸï¼š</p>
<pre><code>var delayedQuery = (function(){
  var previous = 0
  var waiting = 1000
  var sendQuery = function(){
  	// æ‰§è¡Œçš„æ—¶å€™ï¼Œåˆ·æ–° previous
  	previous = (new Date()).getTime()
  	console.log(&quot;sending query&quot;)
	}
  return function(){
   var now = (new Date()).getTime()
   var remain = waiting-(now-previous)
   if(remain&lt;=0){
     sendQuery()
   } else {
     setTimeout(sendQuery,remain)
   }
	}
})()

$(&quot;#queryBtn&quot;).click(delayedQuery)
</code></pre>
<p>ä½†æ˜¯ä¸šåŠ¡ä»£ç  <code>sendQuery</code> è¿˜æ˜¯è€¦åˆäº†åˆ·æ–° <code>previous</code> çš„é€»è¾‘ï¼Œå…¶æ¬¡å¦‚æœæ¯ä¸ªå»¶è¿Ÿæ‰§è¡Œçš„è¯·æ±‚éƒ½åšè¿™æ ·çš„åŒ…è£¹å°±å¤ªå†—ä½™äº†ã€‚å†™ä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œå°†"éœ€è¦æ§åˆ¶è°ƒç”¨é¢‘ç‡çš„å‡½æ•°"å’Œ"å¯¹è°ƒç”¨é¢‘åº¦çš„é™åˆ¶é¢‘ç‡"ä¼ ç»™é€šç”¨å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªé™åˆ¶äº†æ‰§è¡Œé¢‘ç‡çš„å‡½æ•°</p>
<pre><code>function throttle(func, waiting){
  var previos = 0
  // åˆ›å»ºä¸€ä¸ª wrapperï¼Œè§£è€¦ func å’Œ previous ç­‰å˜é‡
  var later = function(){
    previous = (new Date()).getTime()
    func()
  }
  return function(){
    var now = (new Date()).getTime()
    var remain = waiting - (now - previous)
    console.log(&quot;need waiting&quot; + remain + &quot;ms&quot;)
    if(remain &lt;= 0){
      console.log(&quot;immediately&quot;)
      later()
    } else {
      console.log(&quot;delayed&quot;)
      setTimeout(later, remain)
    }
  }
}

var sendQuery = function(){
  console.log(&quot;sending query&quot;)
}
delayedQuery = throttle(sendQuery,1000)
</code></pre>
<p>ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªä¿éšœäº†ç¬¬ä¸€æ¬¡å›è°ƒå’Œæ¥ä¸‹æ¥æ‰€æœ‰å›è°ƒçš„é—´éš”æ‰§è¡Œï¼Œè€Œæ²¡æœ‰ä¿éšœåˆ°å„ä¸ªå›è°ƒé—´ç›¸äº’çš„é—´éš”æ‰§è¡Œï¼Œæ‰€ä»¥è¢«å»¶åæ‰§è¡Œçš„é‚£äº›è¯·æ±‚ä¼šå†æŸä¸ªç›¸è¿‘çš„æ—¶é—´ç‚¹åŒæ—¶å‘ç”Ÿã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œunderscore çš„å®ç°æ›´å¥å£®</p>
<p><strong><code>_.throttle</code> &ldquo;èŠ‚æµé˜€&rdquo;</strong></p>
<pre><code>_.throttle = function(func, wait, options){
  // timeout æ ‡è¯†æœ€è¿‘ä¸€æ¬¡è¢«è¿½è¸ªçš„è°ƒç”¨
  // context å’Œ args ç¼“å­˜ func æ‰§è¡Œæ—¶éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼Œresult ç¼“å­˜ func æ‰§è¡Œç»“æœ
  var timeout, context, args, result
  var previous = 0
  if(!options) options = {}

  //åˆ›å»ºä¸€ä¸ªå»¶åæ‰§è¡Œå‡½æ•°åŒ…è£¹ä½ func çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œé€šè¿‡é—­åŒ…è®¿é—®
  var later = function(){
  	// è‹¥è®¾å®šäº†å¼€å§‹è¾¹ç•Œä¸æ‰§è¡Œï¼Œä¸Šæ¬¡æ‰§è¡Œæ—¶é—´å§‹ç»ˆä¸º 0
    previous = options.leading === false ? 0 : _.now()
    // æ¸…ç©ºå®šæ—¶å™¨
    timeout = null
    result = func.apply(context, args)
    if(!timeout) context = args = null
  }
  // è¿”å›ä¸€ä¸ª throttle åŒ–çš„å‡½æ•°
  var throttled = function(){
    var now = _.now()
    // é¦–æ¬¡æ‰§è¡Œï¼Œå¦‚æœè®¾å®šå¼€å§‹è¾¹ç•Œä¸æ‰§è¡Œï¼Œå°†ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´å®šä¸ºå½“å‰æ—¶é—´
    if(!previos &amp;&amp; options.leading === false) previos = now
    var remaining = wait - (now - previous)
    context = this
    args = arguments
    if(remaining &lt;= 0 || remaining &gt; wait){
      if(timeout){
        clearTimeout(timeout)
        timeout = null
      }
      previous = now
      result = func.apply(context, args)
      if(!timeout) context = args = null
      // å»¶è¿Ÿæ‰§è¡Œä¸å­˜åœ¨ï¼Œä¸”æ²¡æœ‰è®¾å®šç»“å°¾è¾¹ç•Œä¸æ‰§è¡Œ
    } else if(!timeout &amp;&amp; options.trailing !== false){
      timeout = setTimeout(later, remaining)
    }
    return result
  }
  throttled.cancel = function(){
    clearTimeout(timeout)
    previous = 0
    timeout = context = args = null
  }
  return throttled
}
</code></pre>
<p><strong><code>_.debounce</code></strong> å‡½æ•°å»æŠ–</p>
<pre><code>_.debounce = function(func, wait, immediate){
  var timeout, args, context, timestamp, result
  var later = function (context, args){
  	// å®šæ—¶å™¨è®¾ç½®å›è°ƒ later æ–¹æ³•çš„è§¦å‘æ—¶é—´ï¼Œå’Œè¿ç»­äº‹ä»¶è§¦å‘çš„æœ€åä¸€æ¬¡æ—¶é—´æˆ³çš„é—´éš”
  	// å³æŸäººè¿›å…¥ç”µæ¢¯æ—¶é—´å’Œä¸Šä¸€æ¬¡ç”µæ¢¯è¿é€æ—¶é—´çš„é—´éš”
    var last = _.now() - timestamp
		if(last &lt; wait &amp;&amp; last &gt;= 0){
      timeout = setTimeout(later, wait - last)
		} else {
      timeout = null
      if(!immediate){
        result = func.apply(context, args)
        if(!timeout)
        	context = args = null
      }
		}
	}
	return function(){
    context = this
    args = arguments

    timestamp = _.now()
    // ç«‹å³è§¦å‘çš„ä¸¤ä¸ªæ¡ä»¶
    var callNow = immediate &amp;&amp; !timeout
    if(!timeout)
    	timeout = setTimeout(later, wait)
    if(callNow){
      result = func.apply(context, args)
      è§£é™¤å¼•ç”¨
      context = args = null
    }
    return result
	}
}


</code></pre>
</div>
</main>
</body>
</html>